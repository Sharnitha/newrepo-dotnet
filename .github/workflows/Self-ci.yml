name: Frontend-CI

on:
  workflow_dispatch:
  push:
    branches:
      - branchswitch 
  #     - perf20-0724

jobs:   
  
  set_environment:  
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout code
        uses: actions/checkout@v2
  
      - name: Determine environment based on branch
        id: set_env
        run: |
          if [ "$GITHUB_REF" == "refs/heads/branchswitch" ]; then
            echo "environment=DEV" >> "$GITHUB_ENV"
          elif [ "$GITHUB_REF" == "refs/heads/perf20-0724" ]; then
            echo "environment=prod" >> "$GITHUB_ENV"
          else  
            echo "environment=DEV" >> "$GITHUB_ENV"
          fi
          
    outputs:
      environment: ${{ env.environment }}

  CI:
    runs-on: ubuntu-latest
    needs: set_environment
    environment: ${{ needs.set_environment.outputs.environment }}
    env:
      Environments: ${{ needs.set_environment.outputs.environment }}
      workspace: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 
        
      - name: Docker Build
        run: docker build -t ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }} .

      - name: Install Trivy
        run: |
          sudo apt-get -y install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y 
          sudo apt-get install trivy -y

      - name: Trivy Scan
        run: trivy image --severity "HIGH,CRITICAL" --vuln-type "os,library" --exit-code "0" ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }}
        
      - name: Azure CLI
        run: | 
          az login --service-principal -u ${{ secrets.DOCKER_LOGIN }} -p ${{ secrets.DOCKER_PASSWORD }} --tenant ${{ secrets.DOCKER_TENANT }}  
          az account set --subscription ${{ secrets.SUBSCRIPTION_ID }}
        
      - name: Docker build using Dockerfile 
        run: |
          docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_LOGIN }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }}  
          docker history ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }}
    outputs:
      environment: ${{ env.Environments }}

  # DEV_Deploy:
  #   if: github.ref == 'refs/heads/branchswitch'
  #   runs-on: self-hosted
  #   needs: CI
  #   environment: DEV
  #   env:
  #     workspace: ${{ github.workspace }}
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4   
        
  #     - name: Replacetoken
  #       run: |
  #         az login --service-principal -u ${{ secrets.DOCKER_LOGIN }} -p ${{ secrets.DOCKER_PASSWORD }} --tenant ${{ secrets.DOCKER_TENANT }}  
  #         az account set --subscription ${{ secrets.SUBSCRIPTION_ID }}
  #         az webapp config appsettings set --name ${{ secrets.WEBAPP_NAME }} --resource-group ${{ secrets.RG }} --settings @"${{ secrets.JSONFILE }}"

  #     - uses: azure/webapps-deploy@v2
  #       with: 
  #         app-name: ${{ secrets.WEBAPP_NAME }}                                          
  #         publish-profile: ${{ secrets.AZUREWEBAPPPUBLISHPROFILE }}
  #         images: '${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }}'

  # QA_Deploy:
  #   if: github.ref == 'refs/heads/branchswitch'
  #   runs-on: ubuntu-latest
  #   needs: DEV_Deploy
  #   environment: QA
  #   env:
  #     workspace: ${{ github.workspace }}
  #   steps:
  #     - uses: trstringer/manual-approval@v1
  #       timeout-minutes: 5
  #       with:
  #         secret: ${{ secrets.TOKEN }}
  #         approvers: Sharnitha
  #         minimum-approvals: 1
  #         issue-title: "Deploying v1.3.5 to deploy from deploy"
  #         issue-body: "Please approve or deny the deployment of v1.3.5."
  #         exclude-workflow-initiator-as-approver: false
  #         additional-approved-words: ''
  #         additional-denied-words: ''
          
  #     - name: Checkout code
  #       uses: actions/checkout@v4 
        
  #     - name: Replacetoken
  #       run: |
  #         az login --service-principal -u ${{ secrets.DOCKER_LOGIN }} -p ${{ secrets.DOCKER_PASSWORD }} --tenant ${{ secrets.DOCKER_TENANT }}  
  #         az account set --subscription ${{ secrets.SUBSCRIPTION_ID }}
  #         az webapp config appsettings set --name ${{ secrets.WEBAPP_NAME }} --resource-group ${{ secrets.RG }} --settings @"${{ secrets.JSONFILE }}"

  #     - uses: azure/webapps-deploy@v2
  #       with:  
  #         app-name: ${{ secrets.WEBAPP_NAME }}
  #         publish-profile: ${{ secrets.AZUREWEBAPPPUBLISHPROFILE }}
  #         images: '${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }}'

  # Perf_Deploy:
  #   if: github.ref == 'refs/heads/perf'
  #   runs-on: ubuntu-latest
  #   needs: CI
  #   environment: ${{ needs.CI.outputs.environment }}
  #   env:
  #     workspace: ${{ github.workspace }}
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4 
        
  #     - name: Replacetoken
  #       run: |
  #         az login --service-principal -u ${{ secrets.DOCKER_LOGIN }} -p ${{ secrets.DOCKER_PASSWORD }} --tenant ${{ secrets.DOCKER_TENANT }}  
  #         az account set --subscription ${{ secrets.SUBSCRIPTION_ID }}
  #         az webapp config appsettings set --name ${{ secrets.WEBAPP_NAME }} --resource-group ${{ secrets.RG }} --settings @"${{ secrets.JSONFILE }}"

  #     - uses: azure/webapps-deploy@v2
  #       with: 
  #         app-name: ${{ secrets.WEBAPP_NAME }}
  #         publish-profile: ${{ secrets.AZUREWEBAPPPUBLISHPROFILE }}
  #         images: '${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ github.run_id }}'
